import { useState, useEffect } from 'react'
import axios from 'axios'
import { BarChart, Bar, LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, PieChart, Pie, Cell } from 'recharts'
import NotamMap from './components/NotamMap'
import NotamList from './components/NotamList'
import NotamDetailModal from './components/NotamDetailModal'
import './App.css'

// Vercel Serverless Functionìœ¼ë¡œ í”„ë¡ì‹œ (HTTPS ì§€ì›)
const API_BASE_URL = '/api/proxy'

const COLORS = ['#0088FE', '#00C49F', '#FFBB28', '#FF8042', '#8884d8']

function App() {
  const [stats, setStats] = useState(null)
  const [trendData, setTrendData] = useState([])
  const [dailyChangeData, setDailyChangeData] = useState([])
  const [allNotams, setAllNotams] = useState([])
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState(null)
  const [activeTab, setActiveTab] = useState('dashboard') // dashboard, map, list
  const [selectedNotam, setSelectedNotam] = useState(null)

  useEffect(() => {
    loadData()
  }, [])

  const loadData = async () => {
    try {
      setLoading(true)

      // í†µê³„ ë¡œë“œ
      const statsResponse = await axios.get(`${API_BASE_URL}?path=/notams/stats`)
      setStats(statsResponse.data)

      // ìµœê·¼ 7ì¼ ì¶”ì„¸ ë¡œë“œ
      const days = []
      for (let i = 6; i >= 0; i--) {
        const date = new Date()
        date.setDate(date.getDate() - i)
        const dateStr = date.toISOString().split('T')[0]

        try {
          const response = await axios.get(`${API_BASE_URL}?path=/notams/stats?date=${dateStr}`)
          days.push({
            date: `${date.getMonth() + 1}/${date.getDate()}`,
            í™œì„±: response.data.active || 0,
            ë§Œë£Œ: response.data.expired || 0,
          })
        } catch (err) {
          console.error(`Error loading stats for ${dateStr}:`, err)
        }
      }
      setTrendData(days)

      setLoading(false)
    } catch (err) {
      console.error('Error loading data:', err)
      setError(err.message)
      setLoading(false)
    }
  }

  const getStatusData = () => {
    if (!stats) return []
    return [
      { name: 'í™œì„±', value: stats.active, color: '#00C49F' },
      { name: 'ë§Œë£Œ', value: stats.expired, color: '#FF8042' },
      { name: 'ì˜ˆì •', value: stats.scheduled, color: '#0088FE' },
    ]
  }

  if (loading) {
    return (
      <div className="loading-container">
        <div className="spinner"></div>
        <h2>NOTAM ë°ì´í„° ë¡œë”© ì¤‘...</h2>
      </div>
    )
  }

  if (error) {
    return (
      <div className="error-container">
        <h2>âš ï¸ ì˜¤ë¥˜ ë°œìƒ</h2>
        <p>{error}</p>
        <button onClick={loadData}>ë‹¤ì‹œ ì‹œë„</button>
      </div>
    )
  }

  return (
    <div className="app">
      <header className="header">
        <h1>ğŸ›« NOTAM ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ</h1>
        <p className="subtitle">ëŒ€í•œë¯¼êµ­ í•­ê³µ ê³µì§€ ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§</p>
        <button className="refresh-btn" onClick={loadData}>ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
      </header>

      {stats && (
        <>
          {/* í†µê³„ ì¹´ë“œ */}
          <div className="stats-grid">
            <div className="stat-card primary">
              <div className="stat-icon">ğŸ“Š</div>
              <div className="stat-content">
                <h3>{stats.total?.toLocaleString() || 0}</h3>
                <p>ì „ì²´ NOTAM</p>
                <small>S3 ì €ì¥ ë°ì´í„°</small>
              </div>
            </div>

            <div className="stat-card success">
              <div className="stat-icon">âœ…</div>
              <div className="stat-content">
                <h3>{stats.active?.toLocaleString() || 0}</h3>
                <p>í™œì„± NOTAM</p>
                <small>í˜„ì¬ ìœ íš¨í•œ ê³µì§€</small>
              </div>
            </div>

            <div className="stat-card warning">
              <div className="stat-icon">â±ï¸</div>
              <div className="stat-content">
                <h3>{stats.expired?.toLocaleString() || 0}</h3>
                <p>ë§Œë£Œëœ NOTAM</p>
                <small>ì¢…ë£Œëœ ê³µì§€</small>
              </div>
            </div>

            <div className="stat-card info">
              <div className="stat-icon">ğŸ“…</div>
              <div className="stat-content">
                <h3>{stats.scheduled?.toLocaleString() || 0}</h3>
                <p>ì˜ˆì •ëœ NOTAM</p>
                <small>í–¥í›„ ì‹œì‘ ì˜ˆì •</small>
              </div>
            </div>
          </div>

          {/* ì°¨íŠ¸ ì„¹ì…˜ */}
          <div className="charts-container">
            {/* NOTAM ì¶”ì„¸ ì°¨íŠ¸ */}
            <div className="chart-card">
              <h2>ğŸ“ˆ ìµœê·¼ 7ì¼ NOTAM ì¶”ì„¸</h2>
              <ResponsiveContainer width="100%" height={300}>
                <BarChart data={trendData}>
                  <CartesianGrid strokeDasharray="3 3" />
                  <XAxis dataKey="date" />
                  <YAxis />
                  <Tooltip />
                  <Legend />
                  <Bar dataKey="í™œì„±" fill="#00C49F" />
                  <Bar dataKey="ë§Œë£Œ" fill="#FF8042" />
                </BarChart>
              </ResponsiveContainer>
            </div>

            {/* ìƒíƒœ ë¶„í¬ ì°¨íŠ¸ */}
            <div className="chart-card">
              <h2>ğŸ“Š NOTAM ìƒíƒœ ë¶„í¬</h2>
              <ResponsiveContainer width="100%" height={300}>
                <PieChart>
                  <Pie
                    data={getStatusData()}
                    cx="50%"
                    cy="50%"
                    labelLine={false}
                    label={({ name, value }) => `${name}: ${value.toLocaleString()}`}
                    outerRadius={80}
                    fill="#8884d8"
                    dataKey="value"
                  >
                    {getStatusData().map((entry, index) => (
                      <Cell key={`cell-${index}`} fill={entry.color} />
                    ))}
                  </Pie>
                  <Tooltip />
                </PieChart>
              </ResponsiveContainer>
            </div>
          </div>

          {/* API ì •ë³´ */}
          <div className="api-info">
            <h3>ğŸ“¡ API ì—”ë“œí¬ì¸íŠ¸</h3>
            <div className="endpoint-list">
              <code>GET /api/proxy?path=/notams/stats</code>
              <code>GET /api/proxy?path=/notams/active</code>
              <code>GET /api/proxy?path=/notams/expired</code>
              <code>GET /api/proxy?path=/notams/realtime</code>
            </div>
            <p className="update-time">
              EC2 ì„œë²„: http://3.27.240.67:8000 (Vercel Proxy ê²½ìœ )
              <br />
              ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: {new Date().toLocaleString('ko-KR')}
            </p>
          </div>
        </>
      )}

      <footer className="footer">
        <p>Â© 2024 NOTAM ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ | EC2 + S3 ê¸°ë°˜</p>
      </footer>
    </div>
  )
}

export default App
