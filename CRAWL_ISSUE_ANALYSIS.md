# NOTAM 크롤링 누락 문제 분석

**날짜**: 2025-11-18
**문제**: 11월 18일 발행 NOTAM 32개 중 4개만 수집됨

---

## 문제 원인

### 1. 크롤링 시간
- **마지막 크롤링**: 2025-11-18 06:32:41 (KST)
- **UTC 기준**: 2025-11-17 21:32:41 (UTC)

### 2. 누락된 NOTAM
사용자가 xnotam 사이트에서 확인한 11월 18일 발행 NOTAM 32개:
- D3339/25 - 발행 25-11-18 17:59 ❌ (크롤링 이후 발행)
- E3901/25 - 발행 25-11-18 17:55 ❌ (크롤링 이후 발행)
- E3888/25 - 발행 25-11-18 05:24 ❌ (크롤링 이전이지만 누락)
- C2152/25 - 발행 25-11-18 00:31 ❌ (크롤링 이전이지만 누락)
- ... (총 32개 중 28개 누락)

### 3. 발행 시간 vs 시작 시간 차이

**xnotam의 "Issue time"** = NOTAM 발행 시간 (언제 공지되었는지)
**DB의 "b_start_time"** = NOTAM 유효 시작 시간 (언제부터 효력 발생)

예시:
- D3339/25:
  - Issue time: 25-11-18 17:59 (11월 18일 발행)
  - Start Date: 2511272130 (11월 27일 21:30부터 유효)

- E3901/25:
  - Issue time: 25-11-18 17:55 (11월 18일 발행)
  - Start Date: 2512012330 (12월 1일 23:30부터 유효)

### 4. 현재 DB 상태
```
총 NOTAM: 79개
11월 시작 NOTAM: 68개
11월 18일 시작 NOTAM: 4개 ✓
  - A1502/25 start: 2511181400
  - C2132/25 start: 2511180400
  - A1490/25 start: 2511180800
  - A1487/25 start: 2511180000
```

---

## 왜 누락되었는가?

### 1. 시간 문제
크롤링이 06:32에 실행되었으므로, 그 이후에 발행된 NOTAM(17:52-17:59)은 당연히 수집 안 됨

### 2. API 필터링 문제 가능성
`crawl_7days.py`는 7일(168시간) 전부터 현재까지 발행된 NOTAM을 검색하지만:
- API 서버가 응답을 제한할 수 있음
- 네트워크 오류로 일부 데이터 손실 가능
- 중복 제거 로직에서 실수로 필터링

### 3. 검색 조건 문제
API 검색 조건:
```python
payload = {
    'sch_from_date': start_time.strftime('%Y-%m-%d'),  # 7일 전
    'sch_from_time': start_time.strftime('%H%M'),
    'sch_to_date': utc_now.strftime('%Y-%m-%d'),      # 현재
    'sch_to_time': utc_now.strftime('%H%M'),
    # ...
}
```

이 조건이 **발행 시간** 범위를 지정하는지, **유효 시간** 범위를 지정하는지 불명확

---

## 해결 방법

### 즉시 수행
1. **크롤러 재실행** - 최신 데이터 수집
   ```bash
   python crawl_7days.py
   ```

2. **결과 확인**
   - 11월 18일 발행 NOTAM 32개가 모두 수집되는지 확인
   - D3339/25, E3901/25, E3888/25 등 주요 NOTAM 확인

### 근본 해결
1. **크롤링 주기 설정**
   - 현재: 수동 실행
   - 제안: 매 1시간마다 자동 크롤링

2. **로깅 개선**
   - API 요청/응답 로깅
   - 수집된 NOTAM 개수 추적
   - 에러 발생 시 알림

3. **검증 로직 추가**
   - xnotam 사이트와 DB 데이터 비교
   - 누락된 NOTAM 자동 감지

---

## 다음 단계

1. ✅ 문제 원인 파악 완료
2. ⏳ 크롤러 재실행 중
3. ⏳ 11월 18일 NOTAM 32개 확인 대기
4. ⏳ 앱 테스트

---

**작성**: 2025-11-18
**업데이트**: 크롤러 재실행 후
